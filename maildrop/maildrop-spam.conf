# RSPAM Config
# https://gist.github.com/fgr0/8aa5397ade17a9ce1bd74193f7fb10af#file-maildrop-spam-conf
# https://dalcacer.tumblr.com/post/172372830091/uberspace-u7-mail-filter
SPAMMIN="3"
SPAMMAX="10"

########################################################
# check wether our folder structure is in place, create it if not
########################################################
`test -d "$SPAMDIR"`
if( $RETURNCODE == 1 )  
{
  `maildirmake "$SPAMDIR"`
}
`test -d "$BLACKDIR"`
if( $RETURNCODE == 1 )
{
  `maildirmake "$BLACKDIR"`
}


# check whitelist
if ( /^From:\s*(.*)/ && lookup( $MATCH1 , "$HOME/maildrop-whitelist"))
{
  to "$MAILDIR"
  exit
}

# check blacklist
if ( /^From:\s*(.*)/ && lookup( $MATCH1 , "$HOME/maildrop-blacklist"))
{
  log "Dropped: Sender is blacklisted\n"
  exit
}

# Move all mails with a bar greater `+++` to .Junk
if ( /^X-Rspamd-Bar:\s\+\+\+\+[+]/:h )
{
  log "X-Rspamd-Bar+++: $MATCH1"
  FOLDER = "$SPAMDIR"
  to "$SPAMDIR"
  exit
}

# check spamscore
if ( /^X-Rspamd-Bar: (\+{$SPAMMAX,})$/:h ) 
{
  log "X-Rspamd-Bar_max: $MATCH1"
  log "Dropped: Spamscore too high\n"
  FOLDER = "$BLACKDIR"
  to "$BLACKDIR"
  exit
}
elsif ( /^X-Rspamd-Bar: (\+{$SPAMMIN,})$/:h )
{
  log "X-Rspamd-Bar_min: $MATCH1"
  log "Dropped: Spamscore too low\n"
  FOLDER = "$SPAMDIR"
  to "$SPAMDIR"
  exit
}

